# **2-05 ë¦¬í¬ì§€í„°ë¦¬ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬í•˜ê¸°**

- ë°ì´í„°ë¥¼ CRUDí•˜ë ¤ë©´ DBì™€ ì—°ë™í•˜ëŠ” JPA ë¦¬í¬ì§€í„°ë¦¬ í•„ìš”

## ë¦¬í¬ì§€í„°ë¦¬ ìƒì„±í•˜ê¸°

- ë¦¬í¬ì§€í„°ë¦¬ = Entityë¥¼ í†µí•´ ìƒì„±ëœ DB í…Œì´ë¸”ë“¤ì˜ ë°ì´í„°ë¥¼ CRUD í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” ì¸í„°í˜ì´ìŠ¤(CRUDí•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë©”ì„œë“œë“¤(findAll, save, â€¦)ì„ ì œê³µí•œë‹¤.)

```java
public interface ReviewCommentRepository extends JpaRepository<ReviewComment, Long> {
```

- ReviewCommentRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ ë¦¬í¬ì§€í„°ë¦¬ë¡œ ë§Œë“¤ê¸° ìœ„í•´ JpaRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†í•œë‹¤.
- ì´ì œ, ReviewCommentRepositoryë¡œ ReviewComment í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ CRUD í•  ìˆ˜ ìˆìŒ!

## JUnit

- ë¦¬í¬ì§€í„°ë¦¬ë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì €ì¥í•˜ë ¤ë©´ ì§ˆë¬¸ì„ ë“±ë¡í•˜ëŠ” í™”ë©´+ì»¨íŠ¸ë¡¤ëŸ¬+ì„œë¹„ìŠ¤ íŒŒì¼ ë“±ì´ í•„ìš”í•¨. But, JUnitì„ í†µí•´ ì´ëŸ¬í•œ í”„ë¡œì„¸ìŠ¤ ì—†ì´ ë¦¬í¬ì§€í„°ë¦¬ë§Œ ê°œë³„ì ìœ¼ë¡œ ì‹¤í–‰+í…ŒìŠ¤íŠ¸ í•´ë³¼ ìˆ˜ ìˆìŒ!
- JUnit: í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  ì‹¤í–‰í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë°”ìì˜ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬

```java
@SpringBootTest
class SpaceRepositoryTest {

    @Autowired
    SpaceRepository spaceRepository;

    @Test
    void testJpa(){
        Space space = new Space();
        space.builder()
                .name("test1")
                .address("address1")
                .description("description1")
                .build();
        spaceRepository.save(space);
    }
}

```

- `@SpringBootTest`: í•´ë‹¹ í´ë˜ìŠ¤ê°€ ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì„ì„ ì•Œë¦¼

- `@Autowired` : í•´ë‹¹ ë³€ìˆ˜ì— ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ì…í•¨. = ì˜ì¡´ì„± ì£¼ì…
    - ì´ëŸ¬í•œ ì˜ì¡´ì„± ì£¼ì… ë°©ì‹ì€ `@Autowired` ì™¸ì—ë„ setter, ìƒì„±ìë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ ë“±ì´ ìˆë‹¤. ì´ ì¤‘ì—ì„œë„ ìˆœí™˜ ì°¸ì¡° ë¬¸ì œë•Œë¬¸ì— ìƒì„±ìë¥¼ í†µí•œ ê°ì²´ ì£¼ì… ë°©ì‹ì„ ê¶Œì¥í•œë‹¤.
    - But, í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ê²½ìš° JUnitì´ ìƒì„±ìë¥¼ í†µí•œ ê°ì²´ ì£¼ì…ì„ ì§€ì›í•˜ì§€ ì•Šì•„ì„œ @Autowiredë¥¼ ì‚¬ìš©í•œë‹¤.

- *ìˆœí™˜ ì°¸ì¡° ë¬¸ì œ*ëŠ” **A ê°ì²´ê°€ B ê°ì²´ë¥¼ í•„ìš”ë¡œ í•˜ê³ , ë™ì‹œì— B ê°ì²´ë„ A ê°ì²´ë¥¼ í•„ìš”ë¡œ í•˜ëŠ” ìƒí™©**ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤.
    
    ### ğŸ”„ ìˆœí™˜ ì°¸ì¡° ì˜ˆì‹œ
    
    ```java
    @Component
    public class A {
        private final B b;
    
        @Autowired
        public A(B b) {
            this.b = b;
        }
    }
    
    @Component
    public class B {
        private final A a;
    
        @Autowired
        public B(A a) {
            this.a = a;
        }
    }
    
    ```
    
    - `A`ëŠ” ìƒì„±ìë¡œ `B`ë¥¼ í•„ìš”ë¡œ í•˜ê³ ,
    - `B`ëŠ” ìƒì„±ìë¡œ `A`ë¥¼ í•„ìš”ë¡œ í•©ë‹ˆë‹¤.
    
    ìŠ¤í”„ë§ì´ ë¹ˆì„ ë§Œë“¤ ë•Œ,
    
    1. `A`ë¥¼ ë§Œë“¤ë ¤ê³  ë³´ë‹ˆ `B`ê°€ í•„ìš”í•¨
    2. `B`ë¥¼ ë§Œë“¤ë ¤ê³  ë³´ë‹ˆ `A`ê°€ í•„ìš”í•¨
    3. ë‹¤ì‹œ `A`ë¥¼ ë§Œë“¤ë ¤ê³  ë³´ë‹ˆâ€¦ ë¬´í•œ ë°˜ë³µ ğŸ˜µ
    
    â†’ ê²°êµ­ **BeanCurrentlyInCreationException** ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒ
    
    ### âš–ï¸ ì£¼ì… ë°©ì‹ê³¼ ìˆœí™˜ ì°¸ì¡°
    
    - **ìƒì„±ì ì£¼ì…**: ê°ì²´ê°€ ë§Œë“¤ì–´ì§ˆ ë•Œ ë°˜ë“œì‹œ ì˜ì¡´ì„±ì´ í•„ìš”í•˜ë¯€ë¡œ, ìˆœí™˜ ì°¸ì¡°ê°€ ìˆìœ¼ë©´ **ë°”ë¡œ ì˜ˆì™¸** ë°œìƒ â†’ ë¬¸ì œë¥¼ ì¡°ê¸°ì— ë°œê²¬ ê°€ëŠ¥ âœ…
    - **í•„ë“œ ì£¼ì…(@Autowired) / Setter ì£¼ì…**: ê°ì²´ë¥¼ ë§Œë“¤ê³  ë‚˜ì¤‘ì— ì˜ì¡´ì„±ì„ ì±„ì›Œ ë„£ê¸° ë•Œë¬¸ì—, ìŠ¤í”„ë§ì´ ì„ì‹œ í”„ë¡ì‹œë¥¼ ë„£ì–´ ìˆœí™˜ ì°¸ì¡°ë¥¼ "ì–´ëŠ ì •ë„" ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ. í•˜ì§€ë§Œ ì´ëŠ” **ì•ˆì •ì ì´ì§€ ì•Šê³  ìˆ¨ì€ ë²„ê·¸**ê°€ ë  ìˆ˜ ìˆì–´ ê¶Œì¥ë˜ì§€ ì•ŠìŒ.

```java
@SpringBootTest

    @Autowired
    SpaceRepository spaceRepository;

    @AfterEach
    void tearDown() {
        spaceRepository.deleteAll();
    }

    @Test
    @DisplayName("findAll() í…ŒìŠ¤íŠ¸")
    void testJpa1(){
        Space space1 = new Space();
        space1.builder()
                .name("test1")
                .spaceCategory(SpaceCategory.CAFE)
                .address("address1")
                .description("description1")
                .build();
        spaceRepository.save(space1);

        Space space2 = new Space();
        space2.builder()
                .name("test2")
                .spaceCategory(SpaceCategory.CAFE)
                .address("address2")
                .description("description2")
                .build();
        spaceRepository.save(space2);

        List<Space> all = spaceRepository.findAll();
        assertEquals(2, all.size());
    }

    @Test
    @DisplayName("findById() í…ŒìŠ¤íŠ¸")
    void testJpa2(){
        Space space1 = new Space();
        space1.builder()
                .name("test1")
                .spaceCategory(SpaceCategory.CAFE)
                .address("address1")
                .description("description1")
                .build();
        spaceRepository.save(space1);

        Optional<Space> os = spaceRepository.findById(space1.getId());
        if(os.isPresent()){
            assertEquals(space1.getName(), os.get().getName());
        }
    }

    @Test
    @DisplayName("findByName() í…ŒìŠ¤íŠ¸")
    void testJpa3(){
        Space space1 = new Space();
        space1.builder()
                .name("test1")
                .spaceCategory(SpaceCategory.CAFE)
                .address("address1")
                .description("description1")
                .build();
        spaceRepository.save(space1);

        Optional<Space> os = spaceRepository.findByName(space1.getName());
        if(os.isPresent()){
            assertEquals(space1.getId(), os.get().getId());
        }
    }

    @Test
    @DisplayName("findByNameAndSpaceCategory() í…ŒìŠ¤íŠ¸")
    void testJpa4(){
        Space space1 = new Space();
        space1.builder()
                .name("test1")
                .spaceCategory(SpaceCategory.CAFE)
                .address("address1")
                .description("description1")
                .build();
        spaceRepository.save(space1);

        Optional<Space> os = spaceRepository.findByNameAndSpaceCategory(space1.getName(), space1.getSpaceCategory());
        if(os.isPresent()){
            assertEquals(space1.getId(), os.get().getId());
        }
    }

}
```

- `assertEquals(ê¸°ëŒ“ê°’, ì‹¤ì ¯ê°’)` , `assertTrue()`
- `Optional` : nullê°’ì„ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤. `isPresent()` ë©”ì„œë“œë¡œ ê°’ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŒ.
- ë¦¬í¬ì§€í„°ë¦¬ì˜ ë©”ì„œë“œëª…ì€ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¬¸ì˜ where ì¡°ê±´ì„ ê²°ì •í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

## Transactionalì´ í•„ìš”í•œ ì‹œì 

```java
@SpringBootTest
class SbbApplicationTests {

    @Autowired
    private QuestionRepository questionRepository;

    @Test
    @Transactional // <- ì¶”ê°€í•´ì•¼ì§€ í•´ê²° ê°€ëŠ¥
    void testJpa() {
        Optional<Question> oq = questionRepository.findById(2);
        assertTrue(oq.isPresent());
        Question q = oq.get();

        List<Answer> answerList = q.getAnswerList();

        assertEquals(1, answerList.size());
        assertEquals("ë„¤ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.", answerList.get(0).getContent());
    }
}

```

- ìœ„ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´, LazyInitializationExceptionì´ ë°œìƒí•œë‹¤.
    
    â‡’ `findById` ë©”ì„œë“œë¡œ ê°ì²´ë¥¼ ì¡°íšŒí•˜ê³  ë‚˜ë©´ DB ì„¸ì…˜(ìŠ¤í”„ë§ë¶€íŠ¸&DB ì‚¬ì´ì˜ ì—°ê²°)ì´ ëŠì–´ì§€ê¸° ë•Œë¬¸ì— `q.getAnswerList()`ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ ì—ëŸ¬ ë°œìƒ.
    
- Lazy(ì§€ì—°) ë°©ì‹: answer ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í•„ìš”í•œ ì‹œì ì— ê°€ì ¸ì˜¤ëŠ” ë°©ì‹
- Eager(ì¦‰ì‹œ) ë°©ì‹: qê°ì²´ë¥¼ ì¡°íšŒí•  ë•Œ ë¯¸ë¦¬ answer ë¦¬ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹
- â†’ @OneToManyt, @ManyToOne ë“±ì— ì˜µì…˜ìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŒ. fetch=FetchType.LAZY ë˜ëŠ” fetch=FetchType.EAGER
- [ì°¸ê³ ] JPAì—ì„œÂ `FetchType`ì˜ ê¸°ë³¸ê°’ì€ ì—°ê´€ ê´€ê³„ì˜ ì¢…ë¥˜ì— ë”°ë¼ ë‹¤ë¦„.Â `@OneToOne` ë° `@ManyToOne` ê´€ê³„ì—ì„œëŠ”Â `FetchType.EAGER`Â (ì¦‰ì‹œ ë¡œë”©)ì´ ê¸°ë³¸ê°’ì´ë©°, `@OneToMany` ë° `@ManyToMany` ê´€ê³„ì—ì„œëŠ”Â `FetchType.LAZY`Â (ì§€ì—° ë¡œë”©)ì´ ê¸°ë³¸ê°’ì„.
- í•˜ì§€ë§Œ, ì‹¤ì œ ì„œë²„ì—ì„œ JPA í”„ë¡œê·¸ë¨ë“¤ì„ ì‹¤í–‰í•  ë•ŒëŠ” DBì„¸ì…˜ì´ ì¢…ë£Œë˜ì§€ ì•Šì•„ì„œ ì´ëŸ¬í•œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ. í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ìˆ˜í–‰í•  ë•Œë§Œ ë°œìƒí•˜ëŠ” ë¬¸ì œì„! ë”°ë¼ì„œ, FetchType.EAGERì„ ì„¤ì •í•˜ê¸°ë³´ë‹¤ëŠ” `@Transactional` ì„ ë¶™ì—¬ì„œ í•´ë‹¹ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë©”ì„œë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ DB ì„¸ì…˜ì„ ìœ ì§€í•˜ê²Œ í•˜ë©´ ë¨!


